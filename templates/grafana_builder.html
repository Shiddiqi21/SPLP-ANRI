<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafana URL Builder - SPLP</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #0288D1 0%, #03A9F4 100%);
            color: white;
            padding: 12px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .container-main {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, #0288D1 0%, #03A9F4 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 20px;
        }

        .card-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .card-body {
            padding: 25px;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .form-label i {
            color: #0288D1;
            margin-right: 5px;
        }

        .form-select,
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .form-select:focus,
        .form-control:focus {
            border-color: #0288D1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(2, 136, 209, 0.1);
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-check-input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #0288D1;
        }

        .form-check-label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        .btn-generate {
            background: linear-gradient(135deg, #0288D1 0%, #03A9F4 100%);
            color: white;
            border: none;
            padding: 14px 40px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(2, 136, 209, 0.4);
        }

        .url-box {
            background: #f8f9fa;
            border: 2px solid #0288D1;
            border-radius: 8px;
            padding: 15px;
            padding-right: 100px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            word-break: break-all;
            position: relative;
            color: #333;
        }

        .btn-copy {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: #0288D1;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .btn-copy:hover {
            background: #0277BD;
        }

        .preview-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .preview-box a {
            color: #0288D1;
        }

        .section-divider {
            margin: 25px 0;
            border: 0;
            border-top: 1px solid #e0e0e0;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #0288D1;
            color: white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
        }

        .instructions-list {
            list-style: none;
            padding: 0;
        }

        .instructions-list li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions-list li::before {
            content: counter(step);
            counter-increment: step;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #0288D1;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
        }

        .instructions-list {
            counter-reset: step;
        }

        .small-text {
            font-size: 12px;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e0e0e0;
            border-top-color: #0288D1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Viz Type Cards */
        .viz-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .viz-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            position: relative;
            background: white;
        }

        .viz-card:hover {
            border-color: #0288D1;
            background: #f0f9ff;
            transform: translateY(-2px);
        }

        .viz-card.selected {
            border-color: #0288D1;
            background: #e1f5fe;
            box-shadow: 0 4px 12px rgba(2, 136, 209, 0.15);
        }

        .viz-card.selected::after {
            content: '\f26a';
            /* bi-check-circle-fill */
            font-family: 'bootstrap-icons';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #0288D1;
            font-size: 18px;
        }

        .viz-icon {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
            color: #555;
            transition: color 0.2s;
        }

        .viz-card.selected .viz-icon {
            color: #0288D1;
        }

        .viz-title {
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
            color: #333;
        }

        .viz-desc {
            font-size: 12px;
            color: #777;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <i class="bi bi-bar-chart-fill" style="font-size: 24px;"></i>
            <span class="header-title">Grafana URL Builder (Fixed)</span>
        </div>
        <a href="/" class="btn-back">
            <i class="bi bi-arrow-left"></i> Kembali ke Dashboard
        </a>
    </div>

    <div class="container-main">
        <!-- Main Card -->
        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-link-45deg"></i> Generate URL untuk Grafana</h3>
                <small style="opacity: 0.8;">Pilih data yang ingin divisualisasikan, lalu salin URL ke Grafana</small>
            </div>
            <div class="card-body">
                <!-- Step 1: Pilih Tipe Visualisasi -->
                <div class="mb-5">
                    <label class="form-label">
                        <span class="step-number">1</span>
                        <i class="bi bi-grid-fill"></i> Pilih Tipe Visualisasi
                    </label>
                    <div class="viz-options">
                        <!-- Bar Chart (Categorical) -->
                        <div class="viz-card selected" onclick="selectVizType('bar', this)">
                            <i class="bi bi-bar-chart-fill viz-icon"></i>
                            <span class="viz-title">Bar Chart</span>
                            <span class="viz-desc">Grafik Batang (Kategori Nama Bulan)</span>
                        </div>

                        <!-- Time Series -->
                        <div class="viz-card" onclick="selectVizType('timeseries', this)">
                            <i class="bi bi-graph-up viz-icon"></i>
                            <span class="viz-title">Time Series</span>
                            <span class="viz-desc">Grafik Waktu (Sumbu X = Time)</span>
                        </div>

                        <!-- Pie Chart -->
                        <div class="viz-card" onclick="selectVizType('pie', this)">
                            <i class="bi bi-pie-chart-fill viz-icon"></i>
                            <span class="viz-title">Pie Chart</span>
                            <span class="viz-desc">Proporsi data (Persentase)</span>
                        </div>

                        <!-- GeoMap -->
                        <div class="viz-card" onclick="selectVizType('geomap', this)">
                            <i class="bi bi-map-fill viz-icon"></i>
                            <span class="viz-title">Peta / GeoMap</span>
                            <span class="viz-desc">Sebaran lokasi instansi</span>
                        </div>

                        <!-- Table -->
                        <div class="viz-card" onclick="selectVizType('table', this)">
                            <i class="bi bi-table viz-icon"></i>
                            <span class="viz-title">Tabel Data</span>
                            <span class="viz-desc">Tampilan data lengkap</span>
                        </div>
                    </div>
                    <input type="hidden" id="selectedVizType" value="bar">
                </div>

                <hr class="section-divider">

                <!-- Step 2: Pilih Tabel -->
                <div class="mb-4">
                    <label class="form-label">
                        <span class="step-number">2</span>
                        <i class="bi bi-table"></i> Pilih Tabel Sumber
                    </label>
                    <div id="tableCheckboxes" class="checkbox-grid">
                        <div class="loading-spinner"></div>
                        <span class="small-text">Memuat daftar tabel...</span>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Step 3: Pilih Kolom (Dynamic visibility) -->
                <div class="mb-4" id="step3Container">
                    <div id="columnSection" style="display: none;">
                        <label class="form-label">
                            <span class="step-number">3</span>
                            <i class="bi bi-list-columns"></i> Pilih Kolom <span class="small-text"
                                id="colHint">(Opsional)</span>
                        </label>
                        <div id="columnCheckboxes" class="checkbox-grid">
                        </div>
                    </div>

                    <div id="columnPlaceholder">
                        <label class="form-label">
                            <span class="step-number">3</span>
                            <i class="bi bi-list-columns"></i> Pilih Kolom
                        </label>
                        <p class="small-text" style="margin-left: 38px;">Pilih tabel terlebih dahulu untuk melihat
                            daftar kolom</p>
                    </div>
                </div>

                <div id="step3GeoMsg" style="display: none; margin-bottom: 24px;">
                    <label class="form-label">
                        <span class="step-number">3</span>
                        <i class="bi bi-list-columns"></i> Kolom Data
                    </label>
                    <div class="alert alert-info" style="margin-left: 38px; font-size: 13px;">
                        <i class="bi bi-info-circle"></i> Untuk GeoMap, kolom Lat/Long & Total akan dipilih otomatis.
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Step 4: Opsi Tambahan (Dynamic) -->
                <div class="mb-4" id="step4Container">
                    <label class="form-label">
                        <span class="step-number">4</span>
                        <i class="bi bi-gear"></i> Konfigurasi Otomatis
                    </label>
                    <div style="margin-left: 38px;">
                        <!-- Auto-configured info -->
                        <div id="configInfo" class="alert alert-light"
                            style="border: 1px solid #e0e0e0; font-size: 13px;">
                            <!-- Filled by JS -->
                        </div>

                        <!-- Manual overrides -->
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useDisplayName" checked>
                            <label class="form-check-label" for="useDisplayName">
                                Gunakan label 'Display Name' (bukan nama kolom asli)
                            </label>
                        </div>

                        <!-- Hidden inputs for logic -->
                        <div style="display:none;">
                            <input type="checkbox" id="formatTimeSeries">
                            <input type="checkbox" id="formatGeoMap">
                            <input type="checkbox" id="excludeMeta">
                        </div>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Generate Button -->
                <div class="text-center mb-4">
                    <button class="btn-generate" onclick="generateURL()">
                        <i class="bi bi-lightning-charge-fill"></i> Generate URL
                    </button>
                </div>

                <!-- Result -->
                <div id="resultSection" style="display: none;">
                    <label class="form-label">
                        <i class="bi bi-clipboard-check"></i> URL untuk Grafana:
                    </label>
                    <div class="url-box" id="urlBox">
                        <span id="generatedUrl"></span>
                        <button class="btn-copy" onclick="copyURL()">
                            <i class="bi bi-clipboard"></i> Salin
                        </button>
                    </div>
                    <div id="modeInfo"
                        style="display: none; margin-top: 10px; padding: 10px 15px; border-radius: 6px; background: #fff8e1; border-left: 4px solid #FF9800; font-size: 13px;">
                    </div>
                    <div class="preview-box">
                        <strong><i class="bi bi-eye"></i> Preview Data</strong>
                        <p class="small-text mb-2">Klik untuk melihat data di tab baru sebelum paste ke Grafana</p>
                        <a href="#" id="previewLink" target="_blank">
                            <i class="bi bi-box-arrow-up-right"></i> Buka Preview
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions Card -->
        <div class="card">
            <div class="card-body">
                <h5 style="color: #0288D1; margin-bottom: 15px;">
                    <i class="bi bi-info-circle"></i> Cara Pakai di Grafana
                </h5>
                <ol class="instructions-list">
                    <li>Salin URL yang sudah di-generate</li>
                    <li>Buka Grafana → Buat Panel Baru</li>
                    <li>Pilih Data Source <strong>"SPLP API"</strong> (Infinity)</li>
                    <li>Paste URL di field <strong>URL</strong></li>
                    <li>Pilih tipe visualisasi (Bar Chart, Pie, dll)</li>
                    <li>Klik <strong>Apply</strong></li>
                </ol>



                <hr style="margin: 15px 0; border-color: #e0e0e0;">

                <h5 style="color: #0288D1; margin-bottom: 10px;">
                    <i class="bi bi-sliders"></i> Setup Variable Filter di Grafana
                </h5>
                <p class="small-text" style="margin-bottom: 10px;">Buat Dashboard Variables di Grafana:
                    <strong>Settings
                        → Variables → Add Variable</strong>
                </p>
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <tr style="background: #f0f7ff;">
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Variable</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">URL (Infinity JSON)</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">JSONPath</th>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Instansi</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">
                            /api/stats/instansi</td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">
                            $.instansi[*]</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Unit Kerja</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">
                            /api/stats/unit-kerja?instansi_id=${instansi}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">
                            $.unit_kerja[*]</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Bulan</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">
                            /api/stats/months</td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">
                            $.months[*]</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Tahun</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">
                            /api/stats/grafana/var/tahun</td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">
                            $.value</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="customModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <i class="bi bi-info-circle-fill" id="modalIcon"></i>
                <h4 id="modalTitle">Konfirmasi</h4>
            </div>
            <div class="modal-body" id="modalMessage">
                Pesan default...
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="btnCancel" onclick="closeModal()">Batal</button>
                <button class="btn-confirm" id="btnConfirm">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal (Success/Error) -->
    <div id="alertModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="justify-content: center;">
                <i class="bi bi-check-circle-fill" id="alertIcon" style="font-size: 40px; color: #4CAF50;"></i>
            </div>
            <div class="modal-body" id="alertMessage" style="text-align: center; padding-top: 10px;">
                Berhasil!
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn-confirm" onclick="closeAlert()">Tutup</button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            color: #0288D1;
        }

        .modal-header h4 {
            margin: 0;
            font-weight: 600;
        }

        .modal-body {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-confirm {
            background: #0288D1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-confirm:hover {
            background: #0277BD;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>

    <script>
        const BASE_URL = window.location.origin;
        let allTables = [];
        let allColumns = {};

        // --- Custom Modal Logic ---
        function showConfirm(title, message, callback) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modalIcon').className = 'bi bi-question-circle-fill';
            document.getElementById('customModal').style.display = 'flex';

            const btnConfirm = document.getElementById('btnConfirm');
            // Clone to remove old listeners
            const newBtn = btnConfirm.cloneNode(true);
            btnConfirm.parentNode.replaceChild(newBtn, btnConfirm);

            newBtn.onclick = () => {
                closeModal();
                if (callback) callback();
            };
        }

        function showAlert(message, type = 'success') {
            const icon = document.getElementById('alertIcon');
            const msg = document.getElementById('alertMessage');

            msg.innerHTML = message;

            if (type === 'success') {
                icon.className = 'bi bi-check-circle-fill';
                icon.style.color = '#4CAF50';
            } else {
                icon.className = 'bi bi-x-circle-fill';
                icon.style.color = '#f44336';
            }

            document.getElementById('alertModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        function closeAlert() {
            document.getElementById('alertModal').style.display = 'none';
        }

        // Close on outside click
        window.onclick = function (event) {
            if (event.target.className === 'modal-overlay') {
                event.target.style.display = 'none';
            }
        }
        // --------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // Force reset to 'bar' to prevent browser autofill from keeping 'timeseries'
            // while the UI visually shows 'Bar Chart' selected.
            document.getElementById('selectedVizType').value = 'bar';

            // Auth check
            if (!localStorage.getItem('access_token')) {
                window.location.href = '/login';
                return;
            }
            loadTables();
            updateConfigInfo(); // Init default state
        });

        // Viz Selection Logic
        function selectVizType(type, element) {
            // Remove active class
            document.querySelectorAll('.viz-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedVizType').value = type;

            updateConfigInfo();
            updateUIForType(type);
        }

        function updateUIForType(type) {
            const step3Container = document.getElementById('step3Container');
            const step3GeoMsg = document.getElementById('step3GeoMsg');

            if (type === 'geomap') {
                step3Container.style.display = 'none';
                step3GeoMsg.style.display = 'block';
            } else {
                step3Container.style.display = 'block';
                step3GeoMsg.style.display = 'none';
            }
        }

        function updateConfigInfo() {
            const type = document.getElementById('selectedVizType').value;
            const infoBox = document.getElementById('configInfo');
            const tsCheck = document.getElementById('formatTimeSeries');
            const geoCheck = document.getElementById('formatGeoMap');
            const metaCheck = document.getElementById('excludeMeta');

            // Reset
            tsCheck.checked = false; // Default off
            geoCheck.checked = false; // Default off
            metaCheck.checked = false; // Default off

            let message = '';

            if (type === 'timeseries') {
                tsCheck.checked = true;
                metaCheck.checked = true; // Exclude meta "Bulan" field since we have specific Time column
                message = `
                    <div style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 5px solid #2196F3;">
                        <strong>Format Time Series AKTIF:</strong> Kolom waktu (Unix Timestamp) otomatis ditambahkan.
                        <hr style="margin: 10px 0; border-top: 1px solid #bbdefb;">
                        <strong>PENTING: Langkah Wajib di Grafana!</strong>
                        <ol style="margin-left: 20px; margin-bottom: 0;">
                            <li>Buka tab <strong>Transformations</strong> (sebelah tab Query).</li>
                            <li>Klik <strong>+ Add transformation</strong> &rarr; Pilih <strong>Convert field type</strong>.
                                <ul style="margin-top: 5px;">
                                    <li><strong>Field:</strong> Pilih <code>Time</code> (atau <code>timestamp</code>).</li>
                                    <li><strong>as:</strong> Pilih <strong>Time</strong>.</li>
                                </ul>
                            </li>
                            <li style="margin-top: 8px;">Klik <strong>+ Add transformation</strong> lagi &rarr; Pilih <strong>Organize fields</strong>.
                                <ul>
                                    <li><strong>Sembunyikan (klik mata)</strong> pada kolom <code>time</code> dan <code>timestamp</code> agar grafik tidak rusak.</li>
                                </ul>
                            </li>
                        </ol>
                    </div>`;
            } else if (type === 'bar') {
                tsCheck.checked = false; // Bar chart uses standard format (Categorical)
                metaCheck.checked = false; // Keep "Nama Bulan" metadata
                message = '<strong>Bar Chart (Mode Fixed):</strong> Grafik Batang Kategori. Kolom "Nama Bulan" disertakan. <br><small>Format Time Series NON-AKTIF.</small>';
            } else if (type === 'pie') {
                metaCheck.checked = true;
                message = '<strong>Pie Chart:</strong> Metadata bulan dinonaktifkan agar Pie Chart bersih.';
            } else if (type === 'geomap') {
                geoCheck.checked = true;
                message = `
                    <div style="background-color: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 5px solid #4CAF50;">
                        <strong>Mode GeoMap AKTIF:</strong> Koordinat Latitude/Longitude otomatis disertakan.
                        <hr style="margin: 10px 0; border-top: 1px solid #c8e6c9;">
                        <strong>Tips Konfigurasi Panel GeoMap:</strong>
                        <ul style="margin-left: 20px; margin-bottom: 0;">
                            <li><strong>Visualization:</strong> Pilih <strong>GeoMap</strong>.</li>
                            <li><strong>Layer Type:</strong> Markers.</li>
                            <li><strong>Location Mode:</strong> Coords.</li>
                            <li><strong>Latitude field:</strong> <code>latitude</code>.</li>
                            <li><strong>Longitude field:</strong> <code>longitude</code>.</li>
                        </ul>
                    </div>`;
            } else {
                message = '<strong>Tabel Standard:</strong> Semua kolom ditampilkan apa adanya.';
            }

            infoBox.innerHTML = message;
        }

        async function loadTables() {
            try {
                const res = await fetch(`${BASE_URL}/api/stats/tables`);
                const data = await res.json();
                allTables = data.tables || [];

                const container = document.getElementById('tableCheckboxes');
                container.innerHTML = '';

                if (allTables.length === 0) {
                    container.innerHTML = '<span class="small-text">Tidak ada tabel tersedia</span>';
                    return;
                }

                allTables.forEach(table => {
                    const div = document.createElement('div');
                    div.className = 'form-check d-flex justify-content-between align-items-center mb-2';
                    const safeName = table.display_name.replace(/'/g, "\\'");
                    div.innerHTML = `
                        <div>
                            <input class="form-check-input table-checkbox" type="checkbox" 
                                   value="${table.id}" id="table_${table.id}"
                                   onchange="onTableChange()">
                            <label class="form-check-label" for="table_${table.id}">
                                ${table.display_name}
                            </label>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (e) {
                document.getElementById('tableCheckboxes').innerHTML =
                    '<span style="color: red;">Gagal memuat tabel. Pastikan server berjalan.</span>';
            }
        }

        async function onTableChange() {
            const checked = document.querySelectorAll('.table-checkbox:checked');
            const columnSection = document.getElementById('columnSection');
            const columnPlaceholder = document.getElementById('columnPlaceholder');
            const columnContainer = document.getElementById('columnCheckboxes');

            if (checked.length === 0) {
                columnSection.style.display = 'none';
                columnPlaceholder.style.display = 'block';
                return;
            }

            columnSection.style.display = 'block';
            columnPlaceholder.style.display = 'none';
            columnContainer.innerHTML = '<div class="loading-spinner"></div>';

            let allCols = [];
            for (const cb of checked) {
                const tableId = cb.value;
                if (!allColumns[tableId]) {
                    try {
                        const res = await fetch(`${BASE_URL}/api/stats/columns?table_id=${tableId}`);
                        const data = await res.json();
                        allColumns[tableId] = data.columns || [];
                    } catch (e) {
                        allColumns[tableId] = [];
                    }
                }

                const tableName = allTables.find(t => t.id == tableId)?.display_name || `Table ${tableId}`;
                allColumns[tableId].forEach(col => {
                    if (col.is_summable) {
                        allCols.push({
                            table_id: tableId,
                            table_name: tableName,
                            name: col.name,
                            display_name: col.display_name
                        });
                    }
                });
            }

            columnContainer.innerHTML = '';

            // Allow all to select all
            if (allCols.length > 0) {
                const selectAllDiv = document.createElement('div');
                selectAllDiv.className = 'form-check w-100 mb-2 pb-2 border-bottom';
                selectAllDiv.innerHTML = `
                    <input class="form-check-input" type="checkbox" id="selectAllCols" onchange="toggleAllCols(this)">
                    <label class="form-check-label fw-bold" for="selectAllCols">Pilih Semua</label>
                 `;
                columnContainer.appendChild(selectAllDiv);
            }

            allCols.forEach((col, idx) => {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input column-checkbox" type="checkbox" 
                           value="${col.name}" data-table="${col.table_id}" id="col_${idx}">
                    <label class="form-check-label" for="col_${idx}">
                        ${col.display_name}
                        <span class="small-text">(${col.table_name})</span>
                    </label>
                `;
                columnContainer.appendChild(div);
            });

            // Add Total as a checkbox at the end
            const totalDiv = document.createElement('div');
            totalDiv.className = 'form-check';
            totalDiv.style.borderTop = '1px solid #eee';
            totalDiv.style.paddingTop = '8px';
            totalDiv.style.marginTop = '8px';
            totalDiv.innerHTML = `
                    <input class="form-check-input column-checkbox" type="checkbox" 
                           value="total" data-table="all" id="col_total" checked
                           style="accent-color: #4CAF50;">
                    <label class="form-check-label" for="col_total"
                           style="font-weight: 600; color: #4CAF50;">
                        <i class="bi bi-calculator"></i> Total
                    </label>
                `;
            columnContainer.appendChild(totalDiv);

            updateConfigInfo(); // Refresh config info
        }

        function toggleAllCols(source) {
            const checkboxes = document.querySelectorAll('.column-checkbox:not(#col_total)');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function generateURL() {
            const vizType = document.getElementById('selectedVizType').value;

            const selectedTables = Array.from(document.querySelectorAll('.table-checkbox:checked')).map(cb => cb.value);
            if (selectedTables.length === 0) {
                showAlert('Pilih minimal satu tabel!', 'error');
                return;
            }

            const selectedCols = Array.from(document.querySelectorAll('.column-checkbox:checked')).map(cb => cb.value);

            const useDisplayName = document.getElementById('useDisplayName').checked;
            const formatTimeSeries = document.getElementById('formatTimeSeries').checked;
            const formatGeoMap = document.getElementById('formatGeoMap').checked; // Implicitly true for geomap type
            const excludeMeta = document.getElementById('excludeMeta').checked;

            // Base URL selection
            let endpoint = '/api/stats/grafana/monthly';
            if (vizType === 'geomap') {
                endpoint = '/api/stats/grafana/geo';
            }

            // Construct Params
            const params = new URLSearchParams();

            // Helper to add if value exists
            const addParam = (key, value) => {
                if (value !== undefined && value !== null && value !== '') params.append(key, value);
            };

            addParam('table_id', selectedTables.join(','));

            // Only add columns param if columns are selected AND visualization is NOT GeoMap (GeoMap uses fixed structure)
            if (vizType !== 'geomap') {
                // Remove 'total' from columns list if it's treated separately? 
                // Actually backend treats 'total' as just another column usually, OR inclusion flag.
                // Wait, backend logic:
                // include_total_col param handles total column separately?
                // Let's check backend.
                // In stats_routes.py: if include_total_col: row['Total'] = total_val
                // So 'total' in columns list is redundant if include_total_col is used.

                // Clean up 'total' from selectedCols list
                const realCols = selectedCols.filter(c => c !== 'total');
                if (realCols.length > 0) {
                    addParam('columns', realCols.join(','));
                }
            }

            addParam('year', '${tahun}');
            addParam('instansi_id', '${instansi}');
            addParam('unit_kerja_id', '${unit_kerja}');
            addParam('months', '${bulan}');

            if (useDisplayName) addParam('use_display_name', 'true');
            if (formatTimeSeries) addParam('format', 'timeseries');

            // IMPORTANT: For Pie Chart, we need exclude_meta=true
            // For Time Series, backend force handles exclude_meta logic, but we send it anyway
            if (excludeMeta) addParam('exclude_meta', 'true');

            // Check Total Column Checkbox
            const totalCb = document.getElementById('col_total');
            if (totalCb && totalCb.checked) {
                addParam('include_total_col', 'true');
            } else {
                addParam('include_total_col', 'false');
            }


            // Construct Final URL
            // Use decodeURIComponent to keep ${} readable
            const finalPath = `${endpoint}?${decodeURIComponent(params.toString())}`;

            // Replace encoded ${} back to normal if browser encoded them (URLSearchParams usually encodes special chars)
            // But we want Grafana variables literal.
            // URLSearchParams encodes $ to %24, { to %7B, } to %7D.
            const decodedPath = finalPath
                .replace(/%24/g, '$')
                .replace(/%7B/g, '{')
                .replace(/%7D/g, '}');

            const fullUrl = `${BASE_URL}${decodedPath}`;

            document.getElementById('generatedUrl').textContent = decodedPath;

            // Show result
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('urlBox').scrollIntoView({ behavior: 'smooth' });

            // Update Preview Link
            document.getElementById('previewLink').href = decodedPath
                .replace('${tahun}', '2025')
                .replace('${instansi}', '')
                .replace('${unit_kerja}', '')
                .replace('${bulan}', ''); // Default preview params
        }

        function copyURL() {
            const urlText = document.getElementById('generatedUrl').textContent;
            navigator.clipboard.writeText(urlText).then(() => {
                const btn = document.querySelector('.btn-copy');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i> Disalin!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }
    </script>
</body>

</html>